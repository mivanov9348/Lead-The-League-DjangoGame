{% extends 'base.html' %}

{% block title %}Chat{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        display: flex;
        height: 80vh;
        background: #f8f9fa;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .user-list {
        width: 25%;
        background: #343a40;
        color: #fff;
        overflow-y: auto;
        padding: 10px;
    }

    .user-list h2 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 20px;
    }

    .user-list ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .user-list li {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #495057;
        transition: background 0.3s;
    }

    .user-list li:hover {
        background: #495057;
    }

    .chat-box {
        width: 75%;
        display: flex;
        flex-direction: column;
        background: #fff;
    }

    .chat-box h2 {
        background: #007bff;
        color: #fff;
        padding: 10px;
        margin: 0;
    }

    #messages {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        background: #e9ecef;
    }

    #messages div {
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 8px;
    }

    #messages div:nth-child(odd) {
        background: #d1e7dd;
    }

    #messages div:nth-child(even) {
        background: #f8d7da;
    }

    .send-box {
        display: flex;
        gap: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-top: 1px solid #ddd;
    }

    .send-box textarea {
        flex: 1;
        height: 60px;
        resize: none;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 14px;
    }

    .send-box button {
        padding: 10px 20px;
        background: #007bff;
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s;
    }

    .send-box button:hover {
        background: #0056b3;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">

    <div class="user-list">
        <h2>Users</h2>
        <ul>
            {% for user in users %}
            <li onclick="selectRecipient({{ user.id }}, '{{ user.username }}')">
                {{ user.username }}
            </li>
            {% endfor %}
        </ul>
    </div>

    <div class="chat-box">
        {% if recipient %}
        <div class="chat-header" style="padding: 10px; background: #007bff; color: #fff;">
            <h2>Chat with {{ recipient.username }}</h2>
        </div>
        <div id="messages" style="flex: 1; overflow-y: auto; padding: 10px; background: #e9ecef;">
            {% for message in messages %}
            <div><strong>{{ message.sender.username }}:</strong> {{ message.content }}</div>
            {% endfor %}
        </div>
        <div class="send-box"
             style="padding: 10px; display: flex; gap: 10px; background: #f8f9fa; border-top: 1px solid #ddd;">
            <textarea id="content" placeholder="Type a message" style="flex: 1; height: 60px; resize: none;"></textarea>
            <input type="hidden" id="recipient_id" value="{{ recipient.id }}">
            <button id="sendBtn" style="padding: 10px 20px; background: #007bff; color: #fff;">Send</button>
        </div>
        {% else %}
        <div style="padding: 10px;">Select a user to start chatting</div>
        {% endif %}
    </div>

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Задаваме името на потребителя за WebSocket връзката
    const username = '{{ recipient.username }}';

    // Създаваме WebSocket връзка към сървъра
const chatSocket = new WebSocket(
    `ws://${window.location.host}/ws/messaging/chat/${username}/`
);

    // Обработка на новопостъпило съобщение от WebSocket
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const message = `<div><strong>${data.sender}:</strong> ${data.message}</div>`;
        const messagesContainer = document.querySelector('#messages');
        messagesContainer.innerHTML += message;

        // Скролиране до последното съобщение
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    };

    // Обработка на затваряне на WebSocket връзката
    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    // Обработчик за бутона за изпращане на съобщение
    document.querySelector('#sendBtn').onclick = function() {
        const messageInputDom = document.querySelector('#content');
        const message = messageInputDom.value;
        if (message.trim() === "") return;

        fetch('messaging/send_message/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'recipient_id': document.querySelector('#recipient_id').value,
                'content': message,
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Ако съобщението е изпратено успешно, го добавяме към чата
                const newMessage = `<div><strong>${data.message.sender}:</strong> ${data.message.content}</div>`;
                document.querySelector('#messages').innerHTML += newMessage;
            }
        })
        .catch(error => console.error('Error sending message:', error));

        // Изчистваме полето за съобщение
        messageInputDom.value = '';
    };

    // Функция за избиране на получател
    function selectRecipient(id, username) {
        window.location.href = `?recipient_id=${id}`;
    }
</script>

{% endblock %}
