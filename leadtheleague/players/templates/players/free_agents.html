{% extends 'base.html' %}

{% block title %}Free Agents{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">

<style>
    :root {
            --primary-color: #1b6ca8; /* Основен син цвят */
            --secondary-color: #f2f6fa; /* Светлосин фон */
            --highlight-color: #f7b731; /* Жълт за подчертаване */
            --hover-color: #d6e6f2; /* Мек син за hover ефект */
            --text-dark: #222222; /* Тъмен текст */
            --text-light: #ffffff; /* Светъл текст */
            --border-color: #cccccc; /* Граници */
        }

    .table-container {
            background-color: var(--secondary-color);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1;
        }

    h1 {
            color: var(--primary-color);
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
        }

    .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
            background-color: var(--text-light);
        }

    .table thead th {
            background-color: var(--primary-color);
            color: var(--text-light);
            font-weight: bold;
            text-align: center;
            padding: 10px;
        }

    .table tbody tr:nth-child(odd) {
            background-color: var(--secondary-color);
        }

    .table tbody tr:nth-child(even) {
            background-color: var(--text-light);
        }

    .table tbody tr:hover {
            background-color: var(--hover-color);
            transition: background-color 0.3s ease;
        }

    .table tbody td {
            text-align: center;
            padding: 8px;
            color: var(--text-dark);
        }

    .make-offer-btn {
            font-size: 12px;
            padding: 5px 10px;
            background-color: var(--highlight-color);
            color: var(--text-dark);
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

    .make-offer-btn:hover {
            background-color: #e69b21;
            color: var(--text-light);
        }

    .row.mb-3 input,
    .row.mb-3 select {
            border: 2px solid var(--primary-color);
            border-radius: 5px;
            padding: 5px;
        }

    .row.mb-3 input:focus,
    .row.mb-3 select:focus {
            outline: none;
            box-shadow: 0 0 5px var(--primary-color);
        }

        /* Footer стил за DataTables */
    .dataTables_wrapper .dataTables_paginate .paginate_button {
            color: var(--primary-color) !important;
        }

    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background-color: var(--primary-color) !important;
            color: var(--text-light) !important;
            border-radius: 5px;
        }

    .dataTables_wrapper .dataTables_filter input {
            border: 2px solid var(--primary-color);
            border-radius: 5px;
            padding: 5px;
        }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid table-container">
    <div class="row mb-3">
        <div class="col-md-3">
            <input type="text" id="filterName" class="form-control" placeholder="Filter by Name">
        </div>
        <div class="col-md-3">
            <input type="text" id="filterNationality" class="form-control" placeholder="Filter by Nationality">
        </div>
        <div class="col-md-3">
            <select id="filterPosition" class="form-control">
                <option value="">Filter by Position</option>
                <option value="Goalkeeper">Goalkeeper</option>
                <option value="Defender">Defender</option>
                <option value="Midfielder">Midfielder</option>
                <option value="Attacker">Attacker</option>
            </select>
        </div>
        <div class="col-md-3">
            <input type="number" id="filterAge" class="form-control" placeholder="Filter by Age">
        </div>
    </div>

    <div class="table-responsive">
        <table id="freeAgentsTable" class="display table table-bordered table-striped" style="width: 100%;">
            <thead>
            <tr>
                <th>Name</th>
                <th>Age</th>
                <th>Nat</th>
                <th>Pos</th>
                <th>Agent</th>
                <th title="Handling">H</th>
                <th title="Reflexes">R</th>
                <th title="Finishing">F</th>
                <th title="Shooting">S</th>
                <th title="Technique">T</th>
                <th title="Passing">P</th>
                <th title="Crossing">C</th>
                <th title="Tackling">Tck</th>
                <th title="Strength">Str</th>
                <th title="Determination">Det</th>
                <th title="Ball Control">BC</th>
                <th title="Dribbling">Dr</th>
                <th title="Speed">Sp</th>
                <th title="Vision">V</th>
                <th title="Work Rate">WR</th>
                <th>$</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            {% for player in free_agents %}
            <tr>
                <td>{{ player.name }}</td>
                <td>{{ player.age }}</td>
                <td title={{player.nationality}}>{{ player.nationalityabbr }}</td>
                <td>{{ player.positionabbr }}</td>
                <td>{{ player.agent }}</td>
                <td>{{ player.handling }}</td>
                <td>{{ player.reflexes }}</td>
                <td>{{ player.finishing }}</td>
                <td>{{ player.shooting }}</td>
                <td>{{ player.technique }}</td>
                <td>{{ player.passing }}</td>
                <td>{{ player.crossing }}</td>
                <td>{{ player.tackling }}</td>
                <td>{{ player.strength }}</td>
                <td>{{ player.determination }}</td>
                <td>{{ player.ballcontrol }}</td>
                <td>{{ player.dribbling }}</td>
                <td>{{ player.speed }}</td>
                <td>{{ player.vision }}</td>
                <td>{{ player.workrate }}</td>
                <td>${{ player.price }}</td>
                <td>
                    <button class="btn btn-primary make-offer-btn" data-player-id="{{ player.id }}">Make Offer</button>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<div class="modal fade" id="offerModal" tabindex="-1" aria-labelledby="offerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="offerModalLabel">Make an Offer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="playerInfo"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Reject</button>
                <button type="button" class="btn btn-primary" id="submitOffer">Submit</button>
            </div>

        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
 $(document).ready(function () {
    const table = $('#freeAgentsTable').DataTable();

    let selectedPlayerId;
    let playerPrice;

    // Delegate event for "Make Offer" button
    $('#freeAgentsTable').on('click', '.make-offer-btn', function () {
        selectedPlayerId = $(this).data('player-id');
        console.log("Selected Player ID:", selectedPlayerId);

        if (!selectedPlayerId) {
            alert("Player ID is missing!");
            return;
        }

        // Fetch player information
        $.ajax({
            url: `/players/${selectedPlayerId}/info/`,
            type: 'GET',
            success: function (data) {
                playerPrice = data.price; // Store player price
                $('#playerInfo').html(`
                    <p><strong>Name:</strong> ${data.name}</p>
                    <p><strong>Age:</strong> ${data.age}</p>
                    <p><strong>Nationality:</strong> ${data.nationality}</p>
                    <p><strong>Position:</strong> ${data.position}</p>
                    <p><strong>Price:</strong> $${data.price}</p>
                `);
                $('#offerModal').modal('show');
            },
            error: function (xhr) {
                console.error(xhr);
                alert('Failed to fetch player info.');
            }
        });
    });

    // Submit offer
    $('#submitOffer').on('click', function () {
        if (!playerPrice || playerPrice <= 0) {
            alert("Invalid player price.");
            return;
        }

        $.ajax({
            url: `/players/${selectedPlayerId}/offer/`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ offer_amount: playerPrice }),
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            success: function (response) {
                if (response.status === 'success') {
                    Swal.fire('Success', response.message, 'success').then(() => {
                        $('#offerModal').modal('hide');
                        location.reload();
                    });
                } else {
                    Swal.fire('Error', response.message, 'error');
                }
            },
            error: function (xhr) {
                alert(xhr.responseJSON?.message || 'Error submitting offer.');
            }
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === name + '=') {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Add event listeners for filtering
    $('#filterName').on('keyup', function () {
        table.column(0).search(this.value).draw(); // Filter by Name (column 0)
    });

    $('#filterNationality').on('keyup', function () {
        table.column(2).search(this.value).draw(); // Filter by Nationality (column 2)
    });

    $('#filterPosition').on('change', function () {
        table.column(3).search(this.value).draw(); // Filter by Position (column 3)
    });

    $('#filterAge').on('keyup change', function () {
        const ageFilter = this.value;
        table.column(1).search(ageFilter).draw(); // Filter by Age (column 1)
    });
});
</script>

{% endblock %}

{% block extra_js %}

{% endblock %}